# Deploy to Google Cloud Run
# This workflow builds and deploys the backend and frontend to Cloud Run

name: Deploy to Cloud Run

on:
  push:
    branches:
      - main      # Production deployment
  workflow_dispatch:  # Allow manual trigger

env:
  PROJECT_ID: samaanai-prod-1009-124126
  REGION: us-central1
  ARTIFACT_REPO: samaanai
  BACKEND_SERVICE: samaanai-finance-backend
  FRONTEND_SERVICE: samaanai-finance-frontend
  CLOUD_SQL_INSTANCE: samaanai-prod-1009-124126:us-west1:samaanai-prod-postgres

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: frontend
        run: npm run test:all || true  # Don't fail on test errors for now

      - name: Build frontend
        working-directory: frontend
        run: npm run build

  deploy-backend:
    needs: test
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/172298808029/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions@samaanai-prod-1009-124126.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build and push backend image
        working-directory: backend
        run: |
          IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/backend:${{ github.sha }}
          docker build -t $IMAGE .
          docker push $IMAGE

      - name: Deploy backend to Cloud Run
        run: |
          gcloud run deploy ${{ env.BACKEND_SERVICE }} \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/backend:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --add-cloudsql-instances=${{ env.CLOUD_SQL_INSTANCE }} \
            --set-secrets="SECRET_KEY=FINANCE_SECRET_KEY:latest,DATABASE_URL=FINANCE_DATABASE_URL:latest,PLAID_CLIENT_ID=FINANCE_PLAID_CLIENT_ID:latest,PLAID_SECRET_PRODUCTION=FINANCE_PLAID_SECRET:latest,PLAID_ENCRYPTION_KEY=FINANCE_PLAID_ENCRYPTION_KEY:latest,GOOGLE_CLIENT_ID=GOOGLE_CLIENT_ID:latest,GOOGLE_CLIENT_SECRET=GOOGLE_CLIENT_SECRET:latest" \
            --set-env-vars="ENVIRONMENT=production,PLAID_ENV=production,ALLOWED_HOSTS=*.run.app;finance.samaanai.com,DEBUG=False"

      - name: Get backend URL
        id: backend-url
        run: |
          URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} --region=${{ env.REGION }} --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT

    outputs:
      backend_url: ${{ steps.backend-url.outputs.url }}

  deploy-frontend:
    needs: [test, deploy-backend]
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        env:
          VITE_API_BASE_URL: ${{ needs.deploy-backend.outputs.backend_url }}/api
        run: npm run build

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/172298808029/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions@samaanai-prod-1009-124126.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build and push frontend image
        working-directory: frontend
        run: |
          IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/frontend:${{ github.sha }}
          docker build -t $IMAGE .
          docker push $IMAGE

      - name: Deploy frontend to Cloud Run
        run: |
          gcloud run deploy ${{ env.FRONTEND_SERVICE }} \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/frontend:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated

  notify:
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: samaanai-prod-1009-124126" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend URL**: ${{ needs.deploy-backend.outputs.backend_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Status**: ${{ needs.deploy-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend Status**: ${{ needs.deploy-frontend.result }}" >> $GITHUB_STEP_SUMMARY
